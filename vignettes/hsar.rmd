---
title: "Hierarchical Spatial Simultaneous Autoregressive Model (HSAR)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{hsar}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



An application of HSAR for asking prices in the municipality of Athens
====================================================================

An application of `hsar()`, based on rel data, will be illustrated. The design of the weight matrices needed and the random effect design matrix will be explained.

### Libraries

We start by loading the libraries that will be used.


``` r
library(sf)
library(spdep)
library(tidyverse)
library(HSAR)
```

### Reading the datasets

At the higher level, we have the seven departments of the municipality of Athens and at the lower level we have the point data of the properties.


``` r
data(depmunic)
data(properties)
plot(st_geometry(depmunic),col = sf.colors(12, categorical = TRUE), border = 'grey')
plot(st_geometry(properties),add=TRUE,col="red",pch=16,cex=0.6)
```

![](../man/figures/hsar/p1-1.png)

The characteristics that come with the areal data are the id of the department, the number of airbnb properties, the number of museums, the population, the number of citizens with origin a non european union country, the area of the green space (m^2) and the area of the polygon (km^2).


``` r
names(depmunic)
## [1] "num_dep"    "airbnb"     "museums"    "population" "pop_rest"   "greensp"    "area"      
## [8] "geometry"
depmunic$pop_rest
## [1]  8202  5009  2735  4167  5099 16531  8017
```

The characteristics of the properties are the size (m^2), the asking price (euros), the price per square meter, the age (years) and the shortest distance to metro/train station (m).


``` r
names(properties)
## [1] "id"         "size"       "price"      "prpsqm"     "age"        "dist_metro" "geometry"
hist(properties$age, xlab = "Age", main="Age of the properties")
```

![](../man/figures/hsar/p2-1.png)

Now we are going to create two more variables at the higher, municipality department, level. The first one is the population density per 10k citizens, and the second one is the percentage of non EU citizens.


``` r
depmunic$popdens <- depmunic$population/ (10000*depmunic$area)
depmunic$foreigners <- 100 * depmunic$pop_rest/ depmunic$population
```

The next step is to create the model data that are going to use in the hsar model. For that, we need for each property (lower data), the  data from the relevant department(higher level).


``` r
properties_in_dd <- st_join(properties, depmunic, join = st_within)
```

So now, we know each property, in which department resides and the coresponding data for that polygon. We also need that data in sorting order.


``` r
model.data <- properties_in_dd[order(properties_in_dd$num_dep),]
```

### Create matrices used in the hsar function

In order to run the model we need to create the effect design matrix (Delta), the weight matrix for the high-level - polygon data (M), and the weight matrix for the lower level - point data (W).

In order to define the random effect matrix, we start with estimating the number of properties in each municipality department


``` r
properties_count <- count(as_tibble(model.data), num_dep)
MM <- as.data.frame(properties_count)
```

and by geting the total number of municipality departments (7), we define a vector with the number of municipality department that each property belongs


``` r
Utotal <- dim(MM)[1]
Unum <- MM[,2]
Uid <- rep(c(1:Utotal),Unum)
```

We then define the random effect matrix (Delta) wich has a dimension of 1000x7


``` r
n <- nrow(properties)
Delta <- matrix(0,nrow=n,ncol=Utotal)
for(i in 1:Utotal) {
  Delta[Uid==i,i] <- 1
}

Delta <- as(Delta,"dgCMatrix")
```


Now we estimate the spatial weight matrix at the higher level which in our case is the municipality departments (polygons). So we start with poly2nb which constructs the neighbours list for polygons and then with nb2mat we generate the weight matrix for the neighbours list previously created. Then we transform the weight matrix in a sparse matrix format.


``` r
nb.list <- poly2nb(depmunic)
mat.list <- nb2mat(nb.list,style="W")
M <- as(mat.list,"dgCMatrix")
```

to have a closer look at M , we can visualize it


``` r
plot(st_geometry(depmunic),border = 'grey')
plot(st_centroid(depmunic), add = TRUE)
## Warning: st_centroid assumes attributes are constant over geometries
## Warning in plot.sf(st_centroid(depmunic), add = TRUE): ignoring all but the first attribute
plot(nb.list, st_centroid(depmunic), add = TRUE)
## Warning: st_centroid assumes attributes are constant over geometries
```

![](../man/figures/hsar/p3-1.png)

Similarly, we create the spatial weight matrix at the lower level of properties (point data). So we create the neighbour list at a distance of 1300 meters


``` r
nb.1300 <- dnearneigh(properties,0,1300)

```

and the weights matrix W as follows


``` r
mat.1300 <- nb2mat(nb.1300,style="W")
W <- as(mat.1300,"dgCMatrix")
```

For the W matrix, we can check the neighbours statistics


``` r
nb.1300
## Neighbour list object:
## Number of regions: 1000 
## Number of nonzero links: 170254 
## Percentage nonzero weights: 17.0254 
## Average number of links: 170.254
```

### Run the models

So, having ready the matrices Delta, M and W,  we wun the `hsar()` function


``` r
res.formula <- prpsqm ~ size + age + greensp + population + museums + airbnb
res <- hsar(res.formula,data=model.data,W=W,M=M,Delta=Delta,
            burnin=500, Nsim=1000)
## Warning in spdep::mat2listw(W): style is M (missing); style should be set to a valid value
## Warning in sn2listw(df, style = style, zero.policy = zero.policy, from_mat2listw = TRUE): style is
## M (missing); style should be set to a valid value
## Warning in spdep::mat2listw(W): style is M (missing); style should be set to a valid value
## Warning in sn2listw(df, style = style, zero.policy = zero.policy, from_mat2listw = TRUE): style is
## M (missing); style should be set to a valid value
summary(res)
## 
## Call:
## hsar(formula = res.formula, data = model.data, W = W, M = M, 
##     Delta = Delta, burnin = 500, Nsim = 1000)
## Type:  hsar  
## 
## Coefficients:
##                      Mean          SD
## (Intercept)  1.880411e+03 9.923798760
## size         4.319478e+00 0.446890870
## age         -1.994477e+01 1.268093938
## greensp      1.237404e-03 0.001152329
## population  -8.363637e-03 0.002562514
## museums     -4.545173e+01 9.933713441
## airbnb       5.304487e-01 0.230212003
## 
##  Spatial Coefficients:
##           rho   lambda
## [1,] 0.179876 0.204018
## 
##  Diagnostics 
## Deviance information criterion (DIC): 28200.39 
## Effective number of parameters (pd): -1.610463 
## Log likelihood: -14101.8 
## Pseudo R squared: 0.3609372 
## 
##  Impacts:
##                    direct      indirect         total
## (Intercept)  1.880919e+03 411.841046812  2.292760e+03
## size         4.320645e+00   0.946036856  5.266681e+00
## age         -1.995016e+01  -4.368233882 -2.431839e+01
## greensp      1.237739e-03   0.000271012  1.508751e-03
## population  -8.365896e-03  -0.001831774 -1.019767e-02
## museums     -4.546400e+01  -9.954676424 -5.541868e+01
## airbnb       5.305920e-01   0.116177012  6.467690e-01
## 
##  Quantiles:
##                        5%           25%           50%           75%           95%
## (Intercept)  1.864543e+03  1.873427e+03  1.880335e+03  1.886664e+03  1.897858e+03
## size         3.600517e+00  4.047893e+00  4.298429e+00  4.614641e+00  5.052187e+00
## age         -2.200586e+01 -2.079395e+01 -1.994572e+01 -1.900594e+01 -1.780125e+01
## greensp     -1.367559e-04  4.119328e-04  8.825784e-04  1.847106e-03  3.581595e-03
## population  -1.239103e-02 -1.003380e-02 -8.476218e-03 -6.729587e-03 -3.987552e-03
## museums     -6.071974e+01 -5.247604e+01 -4.535645e+01 -3.873712e+01 -2.991970e+01
## airbnb       1.076656e-01  3.850156e-01  5.450886e-01  6.968176e-01  8.770969e-01
```

and the two simpler models defined for rho = 0 and lambda=0.
So, firstly,  assuming rho = 0 (no interaction effects at the lower level) we get


``` r
res_1 <- hsar(res.formula,data=model.data,W=NULL,M=M,Delta=Delta,burnin=500, Nsim=1000)
## Warning in spdep::mat2listw(W): style is M (missing); style should be set to a valid value
## Warning in sn2listw(df, style = style, zero.policy = zero.policy, from_mat2listw = TRUE): style is
## M (missing); style should be set to a valid value
summary(res_1)
## 
## Call:
## hsar(formula = res.formula, data = model.data, W = NULL, M = M, 
##     Delta = Delta, burnin = 500, Nsim = 1000)
## Type:  hsar with rho = 0  
## 
## Coefficients:
##                      Mean           SD
## (Intercept)  1.880791e+03 1.039298e+01
## size         4.292186e+00 4.428684e-01
## age         -2.003848e+01 1.337680e+00
## greensp      5.083529e-04 7.406559e-04
## population  -7.200829e-03 1.261491e-03
## museums     -4.507794e+01 1.029996e+01
## airbnb       6.512332e-01 2.031754e-01
## 
##  Spatial Coefficients:
##   lambda 
## 0.035762 
## 
##  Diagnostics 
## Deviance information criterion (DIC): 28197.59 
## Effective number of parameters (pd): -2.169403 
## Log likelihood: -14100.97 
## Pseudo R squared: 0.3562617 
## 
##  Quantiles:
##                        5%           25%           50%           75%           95%
## (Intercept)  1.863405e+03  1.873558e+03  1.881071e+03  1.888359e+03  1.897418e+03
## size         3.496696e+00  4.002561e+00  4.290561e+00  4.620917e+00  4.954574e+00
## age         -2.230426e+01 -2.094441e+01 -2.003583e+01 -1.910291e+01 -1.796768e+01
## greensp     -1.114074e-03  1.715942e-04  6.244539e-04  9.610073e-04  1.596669e-03
## population  -9.467664e-03 -7.878938e-03 -7.067834e-03 -6.367625e-03 -5.310410e-03
## museums     -6.159105e+01 -5.160521e+01 -4.548411e+01 -3.786071e+01 -2.884948e+01
## airbnb       3.440962e-01  5.232066e-01  6.385815e-01  7.760372e-01  1.007776e+00
```

and secondly, given lambda = 0 (no interaction at the higher level) we get


``` r
res_2 <- hsar(res.formula,data=model.data,W=W,M=NULL,Delta=Delta,burnin=500, Nsim=1000)
## Warning in spdep::mat2listw(W): style is M (missing); style should be set to a valid value
## Warning in sn2listw(df, style = style, zero.policy = zero.policy, from_mat2listw = TRUE): style is
## M (missing); style should be set to a valid value
summary(res_2)
## 
## Call:
## hsar(formula = res.formula, data = model.data, W = W, M = NULL, 
##     Delta = Delta, burnin = 500, Nsim = 1000)
## Type:  hsar with lambda = 0  
## 
## Coefficients:
##                      Mean           SD
## (Intercept)  1.880769e+03 1.004692e+01
## size         4.265379e+00 4.860553e-01
## age         -1.994508e+01 1.279206e+00
## greensp      8.269326e-04 6.083671e-04
## population  -8.772644e-03 2.250365e-03
## museums     -4.439902e+01 9.864706e+00
## airbnb       5.396291e-01 1.986501e-01
## 
##  Spatial Coefficients:
##      rho 
## 0.192212 
## 
##  Diagnostics 
## Deviance information criterion (DIC): 28199.91 
## Effective number of parameters (pd): -1.769425 
## Log likelihood: -14101.73 
## Pseudo R squared: 0.3591868 
## 
##  Quantiles:
##                        5%           25%           50%           75%           95%
## (Intercept)  1.864584e+03  1.874314e+03  1.880906e+03 1886.92857728  1.897258e+03
## size         3.412458e+00  3.962120e+00  4.284815e+00    4.59054485  5.071521e+00
## age         -2.207171e+01 -2.076709e+01 -1.994121e+01  -19.02032144 -1.785909e+01
## greensp     -1.876021e-04  4.104789e-04  8.675408e-04    0.00122439  1.837631e-03
## population  -1.250746e-02 -1.025022e-02 -8.830115e-03   -0.00734016 -4.893307e-03
## museums     -6.087141e+01 -5.095443e+01 -4.433715e+01  -38.11274549 -2.855947e+01
## airbnb       2.182899e-01  3.977879e-01  5.302861e-01    0.68557952  8.724069e-01
```
